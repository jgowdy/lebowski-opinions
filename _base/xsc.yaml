version: "1.0"
opinion_name: xsc
purity_level: configure-only
container_image: "lebowski/builder:xsc"

description: |
  XSC Baseline Opinion
  
  Build packages with the XSC toolchain (x86_64-xsc-linux-gnu-gcc)
  to generate ring-based syscalls instead of syscall instructions.
  
  This opinion template should be extended by package-specific XSC opinions.
  
  REQUIREMENTS:
  - XSC toolchain installed at /opt/xsc-toolchain/
  - libxsc-rt.so available for linking
  - Container image: lebowski/builder:xsc
  
  VERIFICATION:
  After build, verify zero syscall instructions:
    objdump -d <binary> | grep syscall
  (Expected: no output)

maintainer:
  name: XSC Project
  email: xsc@lebowski.org

tags: [xsc, security, ring-syscalls, zero-syscall]
debian_versions: [bookworm, jammy]

modifications:
  env:
    # Use host GCC with XSC sysroot
    # Note: Stage 1 cross-compiler lacks libgcc, so we use host GCC with --sysroot
    CC: gcc
    CXX: g++
    AR: ar
    RANLIB: ranlib

    # XSC runtime library path
    LD_LIBRARY_PATH: /build/xsc/xsc-toolchain/lib:/build/xsc/xsc-toolchain/sysroot/lib64

    # pkg-config path for XSC libraries
    PKG_CONFIG_PATH: /build/xsc/xsc-toolchain/lib/pkgconfig

  cflags:
    # XSC sysroot - critical for using xsc-glibc
    - "--sysroot=/build/xsc/xsc-toolchain/sysroot"

    # Standard hardening flags (compatible with XSC)
    - "-fstack-protector-strong"
    - "-D_FORTIFY_SOURCE=2"

    # Optimization
    - "-O2"

    # XSC-specific: ensure proper ABI
    - "-fno-omit-frame-pointer"

  cxxflags:
    # XSC sysroot for C++ as well
    - "--sysroot=/build/xsc/xsc-toolchain/sysroot"
    - "-fstack-protector-strong"
    - "-D_FORTIFY_SOURCE=2"
    - "-O2"
    - "-fno-omit-frame-pointer"

  ldflags:
    # XSC sysroot for linking
    - "--sysroot=/build/xsc/xsc-toolchain/sysroot"

    # Link XSC runtime library
    - "-L/build/xsc/xsc-toolchain/lib"
    - "-lxsc-rt"

    # Runtime library path
    - "-Wl,-rpath=/build/xsc/xsc-toolchain/lib"

    # Use XSC dynamic linker
    - "-Wl,--dynamic-linker=/build/xsc/xsc-toolchain/sysroot/lib64/ld-linux-x86-64.so.2"

  configure_args:
    # Build for x86_64 (not cross-compiling, using sysroot instead)
    - "--build=x86_64-pc-linux-gnu"
    - "--host=x86_64-pc-linux-gnu"

verification:
  zero_syscall: true
  
  commands:
    # Extract and verify binaries
    - name: "Extract .deb package"
      cmd: "dpkg-deb -x {package}.deb /tmp/xsc-verify"
    
    - name: "Find all ELF binaries"
      cmd: "find /tmp/xsc-verify -type f -executable -exec file {} \\; | grep ELF"

    - name: "Verify zero syscall instructions"
      cmd: "find /tmp/xsc-verify -type f -executable -exec objdump -d {} \\; | grep syscall"
      expected_exit: 1  # grep returns 1 when no match (success!)
      expected_output: ""  # No syscall instructions found
